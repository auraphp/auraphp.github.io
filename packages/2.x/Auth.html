---
layout: site
active: packages
title: Aura.Auth
permalink: /packages/2.x/Auth.html
---
<script>hljs.initHighlightingOnLoad();</script>

<nav class="navheader">
    <table>
        <tr>
            <th colspan="3" class="curr">2.2. Aura.Auth</th>
        </tr>
        <tr>
            <td class="prev"><a href="/packages/2.x/Accept.html">Aura.Accept</a></td>
            <td class="parent">2. Version 2.x</th>
            <td class="next"><a href="/packages/2.x/Autoload.html">Aura.Autoload</a></td>
        </tr>
    </table>
</nav>
<h1 id="2-2">2.2. Aura.Auth</h1>
<p>Provides authentication functionality and session tracking using various adapters; currently supported adapters are:</p>
<ul>
<li>Apache htpasswd files</li>
<li>SQL tables via the <a href="http://php.net/pdo">PDO</a> extension</li>
<li>IMAP/POP/NNTP via the <a href="http://php.net/imap">imap</a> extension</li>
<li>LDAP and Active Directory via the <a href="http://php.net/ldap">ldap</a> extension</li>
<li>OAuth via customized adapters</li>
</ul>
<p>Note that the purpose of this package is only to authenticate user credentials. It does not currently, and probably will not in the future, handle user account creation and management. That is more properly the domain of application-level functionality, or at least a separate Aura bundle.</p>
<h2 id="2-2-1">2.2.1. Foreword</h2>
<h3 id="2-2-1-1">2.2.1.1. Installation</h3>
<p>This library requires PHP 5.5 or later, and has no userland dependencies.  (As a special consideration, this library is compatible with PHP 5.3 and 5.4 when the <a href="https://github.com/ircmaxell/password_compat">ircmaxell/password-compat</a> package is installed.)</p>
<p>It is installable and autoloadable via Composer as <a href="https://packagist.org/packages/aura/auth">aura/auth</a>.</p>
<p>Alternatively, <a href="https://github.com/auraphp/Aura.Auth/releases">download a release</a> or clone this repository, then require or include its <em>autoload.php</em> file.</p>
<h3 id="2-2-1-2">2.2.1.2. Quality</h3>
<p><a href="https://scrutinizer-ci.com/g/auraphp/Aura.Auth/?branch=develop-2"><img src="https://scrutinizer-ci.com/g/auraphp/Aura.Auth/badges/quality-score.png?b=develop-2" alt="Scrutinizer Code Quality"></a>
<a href="https://scrutinizer-ci.com/g/auraphp/Aura.Auth/?branch=develop-2"><img src="https://scrutinizer-ci.com/g/auraphp/Aura.Auth/badges/coverage.png?b=develop-2" alt="Code Coverage"></a>
<a href="https://travis-ci.org/auraphp/Aura.Auth"><img src="https://travis-ci.org/auraphp/Aura.Auth.png?branch=develop-2" alt="Build Status"></a></p>
<p>To run the unit tests at the command line, issue <code>composer install</code> and then <code>phpunit</code> at the package root. This requires <a href="http://getcomposer.org/">Composer</a> to be available as <code>composer</code>, and <a href="http://phpunit.de/manual/">PHPUnit</a> to be available as <code>phpunit</code>.</p>
<p>This library attempts to comply with <a href="https://github.com/php-fig/fig-standards/blob/master/accepted/PSR-1-basic-coding-standard.md">PSR-1</a>, <a href="https://github.com/php-fig/fig-standards/blob/master/accepted/PSR-2-coding-style-guide.md">PSR-2</a>, and <a href="https://github.com/php-fig/fig-standards/blob/master/accepted/PSR-4-autoloader.md">PSR-4</a>. If
you notice compliance oversights, please send a patch via pull request.</p>
<h3 id="2-2-1-3">2.2.1.3. Community</h3>
<p>To ask questions, provide feedback, or otherwise communicate with the Aura community, please join our <a href="http://groups.google.com/group/auraphp">Google Group</a>, follow <a href="http://twitter.com/auraphp">@auraphp on Twitter</a>, or chat with us on #auraphp on Freenode.</p>
<h2 id="2-2-2">2.2.2. Getting Started</h2>
<h3 id="2-2-2-1">2.2.2.1. Instantiation</h3>
<p>To track authentication state and related information, create an <em>Auth</em> object using the <em>AuthFactory</em>.</p>
<pre><code class="language-php">&lt;?php
$auth_factory = new \Aura\Auth\AuthFactory($_COOKIE);
$auth = $auth_factory-&gt;newInstance();
?&gt;
</code></pre>
<p>You can retrieve authentication information using the following methods on the <em>Auth</em> instance:</p>
<ul>
<li>
<p><code>getUserName()</code>: returns the authenticated username string</p>
</li>
<li>
<p><code>getUserData()</code>: returns the array of optional arbitrary user data</p>
</li>
<li>
<p><code>getFirstActive()</code>: returns the Unix time of first activity (login)</p>
</li>
<li>
<p><code>getLastActive()</code>: return the Unix time of most-recent activity (generally that of the current request)</p>
</li>
<li>
<p><code>getStatus()</code>: returns the current authentication status constant. These constants are:</p>
<ul>
<li>
<p><code>Status::ANON</code> -- anonymous/unauthenticated</p>
</li>
<li>
<p><code>Status::IDLE</code> -- the authenticated session has been idle for too long</p>
</li>
<li>
<p><code>Status::EXPIRED</code> -- the authenticated session has lasted for too long in total</p>
</li>
<li>
<p><code>Status::VALID</code> -- authenticated and valid</p>
</li>
</ul>
</li>
<li>
<p><code>isAnon()</code>, <code>isIdle()</code>, <code>isExpired()</code>, <code>isValid()</code>: these return true or false, based on the current authentication status.</p>
</li>
</ul>
<p>You can also use the <code>set*()</code> variations of the <code>get*()</code> methods above to force the <em>Auth</em> object to whatever values you like. However, because the values are stored in a <code>$_SESSION</code> segment, the values will not be retained if a session is not running.</p>
<p>To retain values in a session, you can start a session by force with <code>session_start()</code> on your own. Alternatively, it would be better to use one of the Aura.Auth package services to handle authentication and session-state management for you.</p>
<h3 id="2-2-2-2">2.2.2.2. Services</h3>
<p>This package comes with three services for dealing with authentication phases:</p>
<ul>
<li>
<p><em>LoginService</em> to log in and start (or resume) a session,</p>
</li>
<li>
<p><em>LogoutService</em> to log out and remove the username and user data in the session (note that this <strong>does not</strong> destroy the session), and</p>
</li>
<li>
<p><em>ResumeService</em> to resume a previously-started session.</p>
</li>
</ul>
<p>You can create each by using the <em>AuthFactory</em>.  For now, we will look at how to force login and logout; later, we will show how to have the service use a credential adapter.</p>
<h4 id="2-2-2-2-1">2.2.2.2.1. Forcing Login</h4>
<p>You can force the <em>Auth</em> object to a logged-in state by calling the <em>LoginService</em> <code>forceLogin()</code> method with a user name and optional arbitrary user data.</p>
<pre><code class="language-php">&lt;?php
// the authentication status is currently anonymous
echo $auth-&gt;getStatus(); // ANON

// create the login service
$login_service = $auth_factory-&gt;newLoginService();

// use the service to force $auth to a logged-in state
$username = 'boshag';
$userdata = array(
    'first_name' =&gt; 'Bolivar',
    'last_name' =&gt; 'Shagnasty',
    'email' =&gt; 'boshag@example.com',
);
$login_service-&gt;forceLogin($auth, $username, $userdata);

// now the authentication status is valid
echo $auth-&gt;getStatus(); // VALID
?&gt;
</code></pre>
<p>Using <code>forceLogin()</code> has these side effects:</p>
<ul>
<li>
<p>it starts a new session if one has not already been started, or resumes a previous session if one exists</p>
</li>
<li>
<p>it regenerates the session ID</p>
</li>
</ul>
<p>The specified user name and user data will be stored in a <code>$_SESSION</code> segment, along with an authentication status of <code>Status::VALID</code>.</p>
<p>Note that <code>forceLogin()</code> does not check any credential sources. You as the application owner are forcing the <em>Auth</em> object to a logged-in state.</p>
<h4 id="2-2-2-2-2">2.2.2.2.2. Forcing Logout</h4>
<p>You can force the <em>Auth</em> object to a logged-out state by calling the <em>LogoutService</em> <code>forceLogout()</code> method.</p>
<pre><code class="language-php">&lt;?php
// the authentication status is currently valid
echo $auth-&gt;getStatus(); // VALID

// create the logout service
$logout_service = $auth_factory-&gt;newLogoutService();

// use the service to force $auth to a logged-out state
$logout_service-&gt;forceLogout($auth);

// now the authentication status is anonymous/invalid
echo $auth-&gt;getStatus(); // ANON
?&gt;
</code></pre>
<p>Using <code>forceLogout()</code> has these side effects:</p>
<ul>
<li>
<p>it clears any existing username and user data from the <code>$_SESSION</code> segment</p>
</li>
<li>
<p>it regenerates the session ID</p>
</li>
</ul>
<p>Note that <code>forceLogout()</code> does not check any credential sources. You as the application owner are forcing the <em>Auth</em> object to a logged-out state.</p>
<p>Note also that this <strong>does not</strong> destroy the session. This is because you may have other things you need in the session memory, such as flash messages.</p>
<h4 id="2-2-2-2-3">2.2.2.2.3. Resuming A Session</h4>
<p>When a PHP request ends, PHP saves the <code>$_SESSION</code> data for you. However, on the next request, PHP does not automatically start a new session for you, so <code>$_SESSION</code> is not automatically available.</p>
<p>You could start a new session yourself to repopulate <code>$_SESSION</code>, but that will incur a performance overhead if you don't actually need the session data.  Similarly, there may be no need to start a session when there was no session previously (and thus no data to repopulate into <code>$_SESSION</code>).  What we need is a way to start a session if one was started previously, but avoid starting a session if none was started previously.</p>
<p>The <em>ResumeService</em> exists to address this problem. When you call the <code>resume()</code> method on the <em>ResumeService</em>, it examines <code>$_COOKIE</code> to see if a session cookie is present:</p>
<ul>
<li>
<p>If the cookie is not present, it will not start a session, and return to the calling code. This avoids starting a session when there is no <code>$_SESSION</code> data to be populated.</p>
</li>
<li>
<p>If the cookie <em>is</em> present, the <em>ResumeService</em> will start a session, thereby repopulating <code>$_SESSION</code>. Then it will update the authentication status depending on how long the session has been in place:</p>
<ul>
<li>
<p>If the session has been idle for too long (i.e., too much time has passed since the last request), the <em>ResumeService</em> will log the user out automatically and return to the calling code.</p>
</li>
<li>
<p>If the session session has expired (i.e., the total logged-in time has been too long), the <em>ResumeService</em> will likewise log the user out automatically and return to the calling code.</p>
</li>
<li>
<p>Otherwise, the <em>ResumeService</em> will update the last-active time on the <em>Auth</em> object and return to the calling code.</p>
</li>
</ul>
</li>
</ul>
<p>Generally, you will want to invoke the <em>ResumeService</em> at the beginning of your application cycle, so that the session data becomes available at the earliest opportunity.</p>
<pre><code class="language-php">&lt;?php
// create the resume service
$resume_service = $auth_factory-&gt;newResumeService();

// use the service to resume any previously-existing session
$resume_service-&gt;resume($auth);

// $_SESSION has now been repopulated, if a session was started previously,
// meaning the $auth object is now populated with its previous values, if any
?&gt;
</code></pre>
<h3 id="2-2-2-3">2.2.2.3. Adapters</h3>
<p>Forcing the <em>Auth</em> object to a particular state is fine for when you want to exercise manual control over the authentication status, user name, user data, and other information. However, it is more often the case that you will want to check user credential input (username and password) against a credential store.  This is where the <em>Adapter</em> classes come in.</p>
<p>To use an <em>Adapter</em> with a <em>Service</em>, you first need to create the <em>Adapter</em>, then pass it to the <em>AuthFactory</em> <code>new*Service()</code> method.</p>
<h4 id="2-2-2-3-1">2.2.2.3.1. Htpasswd Adapter</h4>
<h5 id="2-2-2-3-1-1">2.2.2.3.1.1. Instantiation</h5>
<p>To create an adapter for Apache htpasswd files, call the <em>AuthFactory</em> <code>newHtpasswdAdapter()</code> method and pass the file path of the Apache htpasswd file.</p>
<pre><code class="language-php">&lt;?php
$htpasswd_adapter = $auth_factory-&gt;newHtpasswdAdapter(
    '/path/to/accounts.htpasswd'
);
?&gt;
</code></pre>
<p>This will automatically use the <em>HtpasswdVerifier</em> to check DES, MD5, and SHA passwords from the htpasswd file on a per-user basis.</p>
<h5 id="2-2-2-3-1-2">2.2.2.3.1.2. Service Integration</h5>
<p>You can then pass the <em>Adapter</em> to each <em>Service</em> factory method like so:</p>
<pre><code class="language-php">&lt;?php
$login_service = $auth_factory-&gt;newLoginService($htpasswd_adapter);
$logout_service = $auth_factory-&gt;newLogoutService($htpasswd_adapter);
$resume_service = $auth_factory-&gt;newResumeService($htpasswd_adapter);
?&gt;
</code></pre>
<p>To attempt a user login, pass an array with <code>username</code> and <code>password</code> elements to the <em>LoginService</em> <code>login()</code> method along with the <em>Auth</em> object:</p>
<pre><code class="language-php">&lt;?php
$login_service-&gt;login($auth, array(
    'username' =&gt; 'boshag',
    'password' =&gt; '12345'
));
?&gt;
</code></pre>
<p>For more on <em>LoginService</em> idioms, please see the <a href="#service-idioms">Service Idioms</a> section. (The <em>LogoutService</em> and <em>ResumeService</em> do not need credential information.)</p>
<h4 id="2-2-2-3-2">2.2.2.3.2. IMAP/POP/NNTP Adapter</h4>
<h5 id="2-2-2-3-2-1">2.2.2.3.2.1. Instantiation</h5>
<p>To create an adapter for IMAP/POP/NNTP servers, call the <em>AuthFactory</em> <code>newImapAdapter()</code> method and pass the mailbox specification string, along with any appropriate option constants:</p>
<pre><code class="language-php">&lt;?php
$imap_adapter = $auth_factory-&gt;newImapAdapter(
    '{mail.example.com:143/imap/secure}',
    OP_HALFOPEN
);
?&gt;
</code></pre>
<blockquote>
<p>N.b.: See the <a href="http://php.net/imap_open">imap_open()</a> documentation for more variations on mailbox specification strings.</p>
</blockquote>
<h5 id="2-2-2-3-2-2">2.2.2.3.2.2. Service Integration</h5>
<p>You can then pass the <em>Adapter</em> to each <em>Service</em> factory method like so:</p>
<pre><code class="language-php">&lt;?php
$login_service = $auth_factory-&gt;newLoginService($imap_adapter);
$logout_service = $auth_factory-&gt;newLogoutService($imap_adapter);
$resume_service = $auth_factory-&gt;newResumeService($imap_adapter);
?&gt;
</code></pre>
<p>To attempt a user login, pass an array with <code>username</code> and <code>password</code> elements to the <em>LoginService</em> <code>login()</code> method along with the <em>Auth</em> object:</p>
<pre><code class="language-php">&lt;?php
$login_service-&gt;login($auth, array(
    'username' =&gt; 'boshag',
    'password' =&gt; '12345'
));
?&gt;
</code></pre>
<p>For more on <em>LoginService</em> idioms, please see the <a href="#service-idioms">Service Idioms</a> section. (The <em>LogoutService</em> and <em>ResumeService</em> do not need credential information.)</p>
<h4 id="2-2-2-3-3">2.2.2.3.3. LDAP Adapter</h4>
<h5 id="2-2-2-3-3-1">2.2.2.3.3.1. Instantiation</h5>
<p>To create an adapter for LDAP and Active Directory servers, call the <em>AuthFactory</em> <code>newLdapAdapter()</code> method and pass the server name with a distinguished name (DN) format string:</p>
<pre><code class="language-php">&lt;?php
$ldap_adapter = $auth_factory-&gt;newLdapAdapter(
    'ldaps://ldap.example.com:636',
    'ou=Company Name,dc=Department Name,cn=users,uid=%s'
);
?&gt;
</code></pre>
<blockquote>
<p>N.b.: The username will be escaped and then passed to the DN format string via <a href="http://php.net/sprintf">sprintf()</a>. The completed DN will be used for binding to the server after connection.</p>
</blockquote>
<h5 id="2-2-2-3-3-2">2.2.2.3.3.2. Service Integration</h5>
<p>You can then pass the <em>Adapter</em> to each <em>Service</em> factory method like so:</p>
<pre><code class="language-php">&lt;?php
$login_service = $auth_factory-&gt;newLoginService($ldap_adapter);
$logout_service = $auth_factory-&gt;newLogoutService($ldap_adapter);
$resume_service = $auth_factory-&gt;newResumeService($ldap_adapter);
?&gt;
</code></pre>
<p>To attempt a user login, pass an array with <code>username</code> and <code>password</code> elements to the <em>LoginService</em> <code>login()</code> method along with the <em>Auth</em> object:</p>
<pre><code class="language-php">&lt;?php
$login_service-&gt;login($auth, array(
    'username' =&gt; 'boshag',
    'password' =&gt; '12345'
));
?&gt;
</code></pre>
<p>For more on <em>LoginService</em> idioms, please see the <a href="#service-idioms">Service Idioms</a> section. (The <em>LogoutService</em> and <em>ResumeService</em> do not need credential information.)</p>
<h4 id="2-2-2-3-4">2.2.2.3.4. PDO Adapter</h4>
<h5 id="2-2-2-3-4-1">2.2.2.3.4.1. Instantiation</h5>
<p>To create an adapter for PDO connections to SQL tables, call the <em>AuthFactory</em> <code>newPdoAdapter()</code> method and pass these parameters in order:</p>
<ul>
<li>
<p>a <em>PDO</em> connection instance</p>
</li>
<li>
<p>a indication of how passwords are hashed in the database:</p>
<ul>
<li>
<p>if a <code>PASSWORD_*</code> constant from PHP 5.5 and up, it is treated as <code>password_hash()</code> algorithm for a <em>PasswordVerifier</em> instance (this is the preferred method)</p>
</li>
<li>
<p>if a string, it is treated as a <code>hash()</code> algorithm for a <em>HashVerifier</em> instance</p>
</li>
<li>
<p>otherwise, it is expected to be an implementation of <em>VerifierInterface</em></p>
</li>
</ul>
</li>
<li>
<p>an array of column names: the first element is the username column, the second element is the hashed-password column, and additional columns are used as extra user information to be selected and returned from the database</p>
</li>
<li>
<p>a <code>FROM</code> specification string to indicate one or more table names, with any other <code>JOIN</code> clauses you wish to add</p>
</li>
<li>
<p>an optional <code>WHERE</code> condition string; use this to add extra conditions to the <code>SELECT</code> statement built by the adapter</p>
</li>
</ul>
<p>Here is a legacy example where passwords are MD5 hashed in an accounts table:</p>
<pre><code class="language-php">&lt;?php
$pdo = new \PDO(...);
$hash = new PasswordVerifier('md5');
$cols = ('username', 'md5password');
$from = 'accounts';
$pdo_adapter = $auth_factory-&gt;newPdoAdapter($pdo, $hash, $cols, $from);
?&gt;
</code></pre>
<p>Here is a modern, more complex example that uses bcrypt instead of md5, retrieves extra user information columns from joined tables, and filters for active accounts:</p>
<pre><code class="language-php">&lt;?php
$pdo = new \PDO(...);
$hash = new PasswordVerifier(PASSWORD_BCRYPT);
$cols = array(
    'accounts.username', // "AS username" is added by the adapter
    'accounts.bcryptpass', // "AS password" is added by the adapter
    'accounts.uid AS uid',
    'userinfo.email AS email',
    'userinfo.uri AS website',
    'userinfo.fullname AS display_name',
);
$from = 'accounts JOIN profiles ON accounts.uid = profiles.uid';
$where = 'accounts.active = 1';
$pdo_adapter = $auth_factory-&gt;newPdoAdapter($pdo, $hash, $cols, $from, $where);
?&gt;
</code></pre>
<p>(The additional information columns will be retained in the session data after successful authentication.)</p>
<h5 id="2-2-2-3-4-2">2.2.2.3.4.2. Service Integration</h5>
<p>You can then pass the <em>Adapter</em> to each <em>Service</em> factory method like so:</p>
<pre><code class="language-php">&lt;?php
$login_service = $auth_factory-&gt;newLoginService($pdo_adapter);
$logout_service = $auth_factory-&gt;newLogoutService($pdo_adapter);
$resume_service = $auth_factory-&gt;newResumeService($pdo_adapter);
?&gt;
</code></pre>
<p>To attempt a user login, pass an array with <code>username</code> and <code>password</code> elements to the <em>LoginService</em> <code>login()</code> method along with the <em>Auth</em> object:</p>
<pre><code class="language-php">&lt;?php
$login_service-&gt;login($auth, array(
    'username' =&gt; 'boshag',
    'password' =&gt; '12345'
));
?&gt;
</code></pre>
<p>For more on <em>LoginService</em> idioms, please see the <a href="#service-idioms">Service Idioms</a> section. (The <em>LogoutService</em> and <em>ResumeService</em> do not need credential information.)</p>
<h4 id="2-2-2-3-5">2.2.2.3.5. Custom Adapters</h4>
<p>Although this package comes with multiple <em>Adapter</em> classes, it may be that none of them fit your needs.</p>
<p>You may wish to extend one of the existing adapters to add login/logout/resume behaviors. Alternatively, you can create an <em>Adapter</em> of your own by implementing the <em>AdapterInterface</em> on a class of your choosing:</p>
<pre><code class="language-php">&lt;?php
use Aura\Auth\Adapter\AdapterInterface;
use Aura\Auth\Auth;
use Aura\Auth\Status;

class CustomAdapter implements AdapterInterface
{
    // AdapterInterface::login()
    public function login(array $input)
    {
        if ($this-&gt;isLegit($input)) {
            $username = ...;
            $userdata = array(...);
            $this-&gt;updateLoginTime(time());
            return array($username, $userdata);
        } else {
            throw CustomException('Something went wrong.');
        }
    }

    // AdapterInterface::logout()
    public function logout(Auth $auth, $status = Status::ANON)
    {
        $this-&gt;updateLogoutTime($auth-&gt;getUsername(), time());
    }

    // AdapterInterface::resume()
    public function resume(Auth $auth)
    {
        $this-&gt;updateActiveTime($auth-&gt;getUsername(), time());
    }

    // custom support methods not in the interface
    protected function isLegit($input) { ... }

    protected function updateLoginTime($time) { ... }

    protected function updateActiveTime($time) { ... }

    protected function updateLogoutTime($time) { ... }
}
?&gt;
</code></pre>
<p>You can then pass an instance of the custom adapter when creating services through the <em>AuthFactory</em> methods:</p>
<pre><code class="language-php">&lt;?php
$custom_adapter = new CustomAdapter;
$login_service = $auth_factory-&gt;newLoginService($custom_adapter);
$logout_service = $auth_factory-&gt;newLogoutService($custom_adapter);
$resume_service = $auth_factory-&gt;newResumeService($custom_adapter);
?&gt;
</code></pre>
<h5 id="2-2-2-3-5-1">2.2.2.3.5.1. OAuth Adapters</h5>
<p>Should you desire to handle your authentication through a 3rd party service that uses OAuth 2.0, you'll need to write an adapter that implements <code>Aura\Auth\Adapter\AdapterInterface</code> and provide your own implementation for
fetching the access token and user information. Your implementation can be something you've written yourself or it can be an existing OAuth2 client.</p>
<p>The following example will demonstrate how you'd go about creating this adapter using the <a href="https://github.com/thephpleague/oauth2-client">PHP League's OAuth2 Client</a>. We'll also be using Github as the service provider for this example.</p>
<pre><code class="language-php">&lt;?php
namespace OAuth2\Adapter;

use Aura\Auth\Adapter\AdapterInterface;
use Aura\Auth\Exception;
use Aura\Auth\Auth;
use Aura\Auth\Status;
use League\OAuth2\Client\Provider\AbstractProvider;

class LeagueOAuth2Adapter implements AdapterInterface
{

    /**
     * @var \League\OAuth2\Client\Provider\IdentityProvider
     * The identity provider that the adapter will use
     */
    protected $provider;

    public function __construct(AbstractProvider $provider)
    {
        $this-&gt;provider = $provider;
    }

    /**
     * @param $input an input containing the OAuth 2 code
     * @return array the username and details for the user
     * @throws \Aura\Auth\Exception
     * This method must be implemented to fulfill the contract
     * with AdapterInterface
     */
    public function login(array $input)
    {
        if (!isset($input['code'])) {
            throw new Exception('Authorization code missing.');
        }

        $token = $this-&gt;provider-&gt;getAccessToken(
            'authorization_code',
            array('code' =&gt; $input['code'])
        );

        $details = $this-&gt;provider-&gt;getResourceOwner($token);
        $data = [
            'name' =&gt; $details-&gt;getName(),
            'email' =&gt; $details-&gt;getEmail(),
        ];
        $data['token'] = $token;
        $username = $data['email'];
        return [$username, $data];
    }

    /**
     * @param Auth $auth
     * Logout method is required to fulfill the contract with AdapterInterface
     */
    public function logout(Auth $auth, $status = Status::ANON)
    {
        //nothing to do here
    }

    /**
     * @param Auth $auth
     * Resume method required to fulfill the contract with AdapterInterface
     */
    public function resume(Auth $auth)
    {
        // nothing to do here
    }
}
?&gt;
</code></pre>
<p>As you can see in the code, your adapter will be accepting a client as a
parameter and using that client to fulfill the
\Aura\Auth\Adapter\AdapterInterface contract. This adapter would be commonly
used in an OAuth2 Callback process. Essentially, once you provide your
credentials and authenticate with the 3rd Party service (in this case Github),
you will be redirected back to a script on your server where you'll have to
verify that you sent the request by sending an verification code back to the
service. This is why it's a good idea to use a good OAuth2 client in lieu of
writing your own. Below is an example of what this OAuth2 callback code might
look like.</p>
<pre><code class="language-php">&lt;?php
namespace OAuth2;

use Aura\Auth\AuthFactory;
use League\OAuth2\Client\Provider\Github;
use OAuth2\Adapter\LeagueOAuth2Adapter;
use Aura\Auth\Exception;

require_once 'vendor/autoload.php';

$auth_factory = new AuthFactory($_COOKIE);
$auth = $auth_factory-&gt;newInstance();

$github_provider = new Github(array(
    'clientId' =&gt; 'xxxxxxxxxxxxxxxx',
    'clientSecret' =&gt; 'xxxxxxxxxxxxxxxxxxxx',
    'redirectUri' =&gt; 'http://aura.auth.dev/'
));

if (!isset($_GET['code'])) {
    header('Location: ' . $github_provider-&gt;getAuthorizationUrl());
    exit;
} else {
    $oauth_adapter = new LeagueOAuth2Adapter($github_provider);
    $login_service = $auth_factory-&gt;newLoginService($oauth_adapter);
    try {
        // array is the username and an array of info and indicates successful
        // login
        $data = $login_service-&gt;login($auth, $_GET);
    } catch (Exception $e) {
        // handle the exception
    }
}
?&gt;
</code></pre>
<p>The fact that not every 3rd Party Service returns data the same way means it's
not reasonable for Aura to try to handle every different data set out of the
box. By writing this little bit of code, you can easily implement Aura Auth for
your 3rd Party OAuth2 services.</p>
<h3 id="2-2-2-4">2.2.2.4. Service Idioms</h3>
<h4 id="2-2-2-4-1">2.2.2.4.1. Resuming A Session</h4>
<p>This is an example of the code needed to resume a pre-existing session. Note that the <code>echo</code> statements are intended to explain the different resulting states of the <code>resume()</code> call, and may be replaced by whatever logic you feel is appropriate. For example, you may wish to redirect to a login page when a session has idled or expired.</p>
<pre><code class="language-php">&lt;?php
$auth = $auth_factory-&gt;newInstance();

$resume_service = $auth_factory-&gt;newResumeService(...);
$resume_service-&gt;resume($auth);

switch (true) {
    case $auth-&gt;isAnon():
        echo "You are not logged in.";
        break;
    case $auth-&gt;isIdle():
        echo "Your session was idle for too long. Please log in again.";
        break;
    case $auth-&gt;isExpired():
        echo "Your session has expired. Please log in again.";
        break;
    case $auth-&gt;isValid():
        echo "You are still logged in.";
        break;
    default:
        echo "You have an unknown status.";
        break;
}
?&gt;
</code></pre>
<blockquote>
<p>N.b.: Instead of creating the  <em>Auth</em> and <em>ResumeService</em> objects by hand, you may wish to use a dependency injection container such as <a href="https://github.com/auraphp/Aura.Di">Aura.Di</a> to retain them for shared use throughout your application.</p>
</blockquote>
<h4 id="2-2-2-4-2">2.2.2.4.2. Logging In</h4>
<p>This is an example of the code needed to effect a login. Note that the <code>echo</code> and <code>$log</code> statements are intended to explain the different resulting states of the <code>login()</code> call, and may be replaced by whatever logic you feel is appropriate; in particular, you should probably not expose the exact nature of the failure, to help mitigate brute-force attempts.</p>
<pre><code class="language-php">&lt;?php

class InvalidLoginException extends Exception {}

$auth = $auth_factory-&gt;newInstance();

$login_service = $auth_factory-&gt;newLoginService(...);

try {

    $login_service-&gt;login($auth, array(
        'username' =&gt; $_POST['username'],
        'password' =&gt; $_POST['password'],
    );
    echo "You are now logged into a new session.";

} catch (\Aura\Auth\Exception\UsernameMissing $e) {

    $log-&gt;notice("The 'username' field is missing or empty.");
    throw new InvalidLoginException();

} catch (\Aura\Auth\Exception\PasswordMissing $e) {

    $log-&gt;notice("The 'password' field is missing or empty.");
    throw new InvalidLoginException();

} catch (\Aura\Auth\Exception\UsernameNotFound $e) {

    $log-&gt;warning("The username you entered was not found.");
    throw new InvalidLoginException();

} catch (\Aura\Auth\Exception\MultipleMatches $e) {

    $log-&gt;warning("There is more than one account with that username.");
    throw new InvalidLoginException();

} catch (\Aura\Auth\Exception\PasswordIncorrect $e) {

    $log-&gt;notice("The password you entered was incorrect.");
    throw new InvalidLoginException();

} catch (\Aura\Auth\Exception\ConnectionFailed $e) {

    $log-&gt;notice("Cound not connect to IMAP or LDAP server.");
    $log-&gt;info("This could be because the username or password was wrong,");
    $log-&gt;info("or because the the connect operation itself failed in some way. ");
    $log-&gt;info($e-&gt;getMessage());
    throw new InvalidLoginException();

} catch (\Aura\Auth\Exception\BindFailed $e) {

    $log-&gt;notice("Cound not bind to LDAP server.");
    $log-&gt;info("This could be because the username or password was wrong,");
    $log-&gt;info("or because the the bind operation itself failed in some way. ");
    $log-&gt;info($e-&gt;getMessage());
    throw new InvalidLoginException();

} catch (InvalidLoginException $e) {

    echo "Invalid login details. Please try again.";

}
?&gt;
</code></pre>
<blockquote>
<p>N.b.: Instead of creating the  <em>Auth</em> and <em>LoginService</em> objects by hand, you may wish to use a dependency injection container such as <a href="https://github.com/auraphp/Aura.Di">Aura.Di</a> to retain them for shared use throughout your application.</p>
</blockquote>
<p>Alternatively, you may wish to use credentials from the HTTP <code>Authorization: Basic</code> headers instead of using <code>$_POST</code> or other form-related inputs.  On Apache <code>mod_php</code> you might use the auto-populated <code>$_SERVER['PHP_AUTH_*']</code> values:</p>
<pre><code class="language-php">&lt;?php
$authorization_basic = function () {
    return array(
        isset($_SERVER['PHP_AUTH_USER']) ? $_SERVER['PHP_AUTH_USER'] : null,
        isset($_SERVER['PHP_AUTH_PW'])   ? $_SERVER['PHP_AUTH_PW']   : null,
    );
}

list($username, $password) = $authorization_basic();
$login_service-&gt;login($auth, array(
    'username' =&gt; $username,
    'password' =&gt; $password,
));
?&gt;
</code></pre>
<p>On other servers you may need to extract the credentials from the <code>Authorization: Basic</code> header itself:</p>
<pre><code class="language-php">&lt;?php
$authorization_basic = function () {

    $header = isset($_SERVER['HTTP_AUTHORIZATION'])
            ? $_SERVER['HTTP_AUTHORIZATION']
            : '';

    if (strtolower(substr($header, 0, 6)) !== 'basic ') {
        return array(null, null);
    }

    $encoded = substr($header, 6);
    $decoded = base64_decode($encoded);
    return explode(':', $decoded);

}

list($username, $password) = $authorization_basic();
$login_service-&gt;login($auth, array(
    'username' =&gt; $username,
    'password' =&gt; $password,
));
?&gt;
</code></pre>
<h4 id="2-2-2-4-3">2.2.2.4.3. Logging Out</h4>
<p>This is an example of the code needed to effect a logout. Note that the <code>echo</code> statements are intended to explain the different resulting states of the <code>logout()</code> call, and may be replaced by whatever logic you feel is appropriate.</p>
<pre><code class="language-php">&lt;?php
$auth = $auth_factory-&gt;newInstance();

$logout_service = $auth_factory-&gt;newLogoutService(...);

$logout_service-&gt;logout($auth);

if ($auth-&gt;isAnon()) {
    echo "You are now logged out.";
} else {
    echo "Something went wrong; you are still logged in.";
}
?&gt;
</code></pre>
<blockquote>
<p>N.b.: Instead of creating the  <em>Auth</em> and <em>LogoutService</em> objects by hand, you may wish to use a dependency injection container such as <a href="https://github.com/auraphp/Aura.Di">Aura.Di</a> to retain them for shared use throughout your application.</p>
</blockquote>
<h4 id="2-2-2-4-4">2.2.2.4.4. Custom Services</h4>
<p>You are not restricted to the login, logout, and resume services provided by this package. However, if you build a service of your own, or if you extend one of the provided services, you will have to instantiate that customized service object manually, instead of using the <em>AuthFactory</em>. This can be tedious but is not difficult, especially when using a dependency injection container system such as <a href="https://github.com/auraphp/Aura.Di">Aura.Di</a>.</p>
<h3 id="2-2-2-5">2.2.2.5. Session Management</h3>
<p>The <em>Service</em> objects use a <em>Session</em> object to start sessions and regenerate session IDs. (Note that they <strong>do not</strong> destroy sessions.) The <em>Session</em> object uses the native PHP <code>session_*()</code> functions to manage sessions.</p>
<h4 id="2-2-2-5-1">2.2.2.5.1. Custom Sessions</h4>
<p>If you wish to use an alternative means of managing sessions, implement the <em>SessionInterface</em> on an object of your choice. One way to do this is by by wrapping a framework-specific session object and proxying the <em>SessionInterface</em> methods to the wrapped object:</p>
<pre><code class="language-php">&lt;?php
use Aura\Auth\Session\SessionInterface;

class CustomSession implements SessionInterface
{
    protected $fwsession;

    public function __construct(FrameworkSession $fwsession)
    {
        $this-&gt;fwsession = $fwsession;
    }

    public function start()
    {
        return $this-&gt;fwsession-&gt;startSession();
    }

    public function resume()
    {
        if ($this-&gt;fwsession-&gt;isAlreadyStarted()) {
            return true;
        }

        if ($this-&gt;fwsession-&gt;canBeRestarted()) {
            return $this-&gt;fwsession-&gt;restartSession();
        }

        return false;
    }

    public function regenerateId()
    {
        return $this-&gt;fwsession-&gt;regenerateSessionId();
    }
}
?&gt;
</code></pre>
<p>Then pass that custom session object to the <em>AuthFactory</em> instantiation:</p>
<pre><code class="language-php">&lt;?php
use Aura\Auth\AuthFactory;

$custom_session = new CustomSession(new FrameworkSession);
$auth_factory = new AuthFactory($_COOKIE, $custom_session);
?&gt;
</code></pre>
<p>The factory will pass your custom session object wherever it is needed.</p>
<h4 id="2-2-2-5-2">2.2.2.5.2. Working Without Sessions</h4>
<p>In some situations, such as with APIs where credentials are provided with every request, it may be beneficial to avoid sessions altogether. In this case, pass a <em>NullSession</em> and <em>NullSegment</em> to the <em>AuthFactory</em>:</p>
<pre><code class="language-php">&lt;?php
use Aura\Auth\AuthFactory;
use Aura\Auth\Session\NullSession;
use Aura\Auth\Session\NullSegment;

$null_session = new NullSession;
$null_segment = new NullSegment;
$auth_factory = new AuthFactory($_COOKIE, $null_session, $null_segment);
?&gt;
</code></pre>
<p>With the <em>NullSession</em>, no session will ever be started, and no session ID will be created or regenerated. Likewise, no session will ever be resumed, because it will never have been saved at the end of the previous request. Finally, PHP will never create a session cookie to send in the response.</p>
<p>Similarly, the <em>NullSegment</em> retains authentication information in an object property instead of in a <code>$_SESSION</code> segment. Unlike the normal <em>Segment</em>, which only retains data when <code>$_SESSION</code> is present, the <em>NullSegment</em> will always retain data that is set into it. When the request is over, all information retained in the <em>NullSegment</em> will disappear.</p>
<p>When using the <em>NullSession</em> and <em>NullSegment</em>, you will have to check  credentials via the <em>LoginService</em> <code>login()</code> or <code>forceLogin()</code> method on each request, which in turn will retain the authentication information in the <em>Segment</em>. In an API situation this is often preferable to managing an ongoing session.</p>
<blockquote>
<p>N.b. In an API situation, the credentials may be an API token, or passed as HTTP basic or digest authentication headers.  Pass these to the adapter of your choice.</p>
</blockquote>
<h3 id="2-2-2-6">2.2.2.6. DI Configuration</h3>
<p>Here are some hints regarding configuration of Aura.Auth via Aura.Di.</p>
<h4 id="2-2-2-6-1">2.2.2.6.1. Aura\Auth\Adapter\HtpasswdAdapter</h4>
<pre><code class="language-php">&lt;?php
$di-&gt;params['Aura\Auth\Adapter\HtpasswdAdapter'] = array(
    'file' =&gt; '/path/to/htpasswdfile',
);
?&gt;
</code></pre>
<h4 id="2-2-2-6-2">2.2.2.6.2. Aura\Auth\Adapter\ImapAdapter</h4>
<pre><code class="language-php">&lt;?php
$di-&gt;params['Aura\Auth\Adapter\ImapAdapter'] = array(
    'mailbox' =&gt; '{mail.example.com:143/imap/secure}',
);
?&gt;
</code></pre>
<h4 id="2-2-2-6-3">2.2.2.6.3. Aura\Auth\Adapter\LdapAdapter</h4>
<pre><code class="language-php">&lt;?php
$di-&gt;params['Aura\Auth\Adapter\LdapAdapter'] = array(
    'server' =&gt; 'ldaps://ldap.example.com:636',
    'dnformat' =&gt; 'ou=Company Name,dc=Department Name,cn=users,uid=%s',
);
?&gt;
</code></pre>
<h4 id="2-2-2-6-4">2.2.2.6.4. Aura\Auth\Adapter\PdoAdapter</h4>
<pre><code class="language-php">&lt;?php
$di-&gt;params['Aura\Auth\Adapter\PdoAdapter'] = array(
    'pdo' =&gt; $di-&gt;lazyGet('your_pdo_connection_service'),
    'cols' =&gt; array(
        'username_column',
        'password_column',
    ),
    'from' =&gt; 'users_table',
    'where' =&gt; '',
);
?&gt;
</code></pre>

<nav class="navfooter">
    <table>
        <tr>
            <td class="prev"><a href="/packages/2.x/Accept.html">Prev</a></td>
            <td class="parent"><a href="/packages/2.x/">Up</a></td>
            <td class="next"><a href="/packages/2.x/Autoload.html">Next</a></td>
        </tr>
        <tr>
            <td class="prev">2.1. Aura.Accept</td>
            <td class="parent">2. Version 2.x</td>
            <td class="next">2.3. Aura.Autoload</td>
        </tr>
    </table>
</nav>
